<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="3"
      main_tree_to_execute="BehaviorTree">
  <BehaviorTree ID="BehaviorTree">
    <Sequence>
      <CloseObstacleAvoidance server_timeout="1.0"
                              service_name="/toggle_avoidance"
                              use_avoidance="true"/>
      <FinalSucceedLoop timeout="-1">
        <CtrlObstacleLayerAction enable="true"
                                 map_name="/navit_planner_node/planner_costmap"/>
        <ClearMapAction map_name="controller_costmap"/>
        <FinalSucceedLoop timeout="120">
          <AlwaysSuccess/>
          <SeqExecuteFinalRecovery>
            <Fallback>
              <ComputePathToPose error_code="{error_code}"
                                 goal="{goal}"
                                 path="{global_path}"
                                 planner_id="SmallMapSmacHybrid"
                                 server_name="/compute_path"
                                 server_timeout="0.5"
                                 start="false"/>
              <Switch2 case_1="208"
                       case_2="200"
                       variable="{error_code}">
                <RetryUntilSuccessful num_attempts="2">
                  <Sequence>
                    <ExcapeAction free="130"
                                  r="0.0"
                                  timeout="60"
                                  v="0.2"
                                  w="0.0"/>
                    <ComputePathToPose error_code="{error_code}"
                                       goal="{goal}"
                                       path="{global_path}"
                                       planner_id="SmallMapSmacHybrid"
                                       server_name="/compute_path"
                                       server_timeout="0.5"
                                       start="false"/>
                  </Sequence>
                </RetryUntilSuccessful>
                <ComputePathToPose error_code="{error_code}"
                                   goal="{goal}"
                                   path="{global_path}"
                                   planner_id="HugeMapSmacHybrid"
                                   server_name="/compute_path"
                                   server_timeout="0.5"
                                   start="false"/>
                <AlwaysFailure/>
              </Switch2>
            </Fallback>
            <ExcapeAction free="130"
                          r="0.0"
                          timeout="60"
                          v="0.2"
                          w="0.0"/>
          </SeqExecuteFinalRecovery>
        </FinalSucceedLoop>
        <CtrlObstacleLayerAction enable="false"
                                 map_name="/navit_planner_node/planner_costmap"/>
        <ClearMapAction map_name="planner_costmap"/>
        <Fallback>
          <FollowPath controller_id="ControllerPathFollow"
                      path="{global_path}"
                      server_name="/follow_path"
                      server_timeout="0.5"/>
          <ForceFailure>
            <ExcapeAction free="130"
                          r="0.0"
                          timeout="60"
                          v="0.2"
                          w="0.0"/>
          </ForceFailure>
        </Fallback>
      </FinalSucceedLoop>
      <IsPreciseArrivalAction/>
      <CloseObstacleAvoidance server_timeout="1.0"
                              service_name="/toggle_avoidance"
                              use_avoidance="false"/>
      <PathToPoint Controller_path="{global_path}"
                   tracking_path="{task_point_ros}"/>
      <FollowPath controller_id="tracking"
                  path="{task_point_ros}"
                  server_name="/follow_path"
                  server_timeout="0.5"/>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="ClearMapAction">
      <input_port name="map_name">map_name</input_port>
    </Action>
    <Action ID="CloseObstacleAvoidance">
      <input_port name="server_timeout"/>
      <input_port name="service_name"/>
      <input_port name="use_avoidance"
                  default="false"/>
    </Action>
    <Action ID="ComputePathToPose">
      <output_port name="error_code"
                   default="{error_code}"/>
      <input_port name="goal"
                  default="{task_pose_ros}"/>
      <output_port name="path"
                   default="{global_path}"/>
      <input_port name="planner_id"
                  default="SmallMapSmacHybrid"/>
      <input_port name="server_name"
                  default="/compute_path"/>
      <input_port name="server_timeout"
                  default="0.5"/>
      <input_port name="start"
                  default="false"/>
    </Action>
    <Action ID="CtrlObstacleLayerAction">
      <input_port name="enable">enable</input_port>
      <input_port name="map_name">map_name</input_port>
    </Action>
    <Action ID="ExcapeAction">
      <input_port name="free">free</input_port>
      <input_port name="r">r</input_port>
      <input_port name="timeout">timeout</input_port>
      <input_port name="v">v</input_port>
      <input_port name="w">w</input_port>
    </Action>
    <Control ID="FinalSucceedLoop">
      <input_port name="timeout"/>
    </Control>
    <Action ID="FollowPath">
      <input_port name="controller_id"
                  default="ControllerPathFollow"/>
      <input_port name="path"
                  default="{global_path}"/>
      <input_port name="server_name"
                  default="/follow_path"/>
      <input_port name="server_timeout"
                  default="0.5"/>
    </Action>
    <Action ID="IsPreciseArrivalAction"/>
    <Action ID="PathToPoint">
      <input_port name="Controller_path"
                  default="{task_path_ros}"/>
      <output_port name="tracking_path"
                   default="{task_point_ros}"/>
    </Action>
    <Control ID="SeqExecuteFinalRecovery"/>
  </TreeNodesModel>

</root>
